<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; width: 100%; font-family: system-ui, -apple-system, sans-serif; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-bounce { animation: bounce 0.6s infinite; }
    .animate-pulse { animation: pulse 2s infinite; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ============================================
    // API CONFIGURATION
    // ============================================
    const CONFIG = {
      SUPABASE_URL: 'https://fczusxwyjgatjubqtbot.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjenVzeHd5amdhdGp1YnF0Ym90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0OTM3ODQsImV4cCI6MjA4MDA2OTc4NH0.8dfV1rS421ixeKgY3XAd-LonBwd5X3ZsOdQTr0x2iAs',
      GROQ_API_KEY: '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'
    };

    // ============================================
    // STATE
    // ============================================
    let state = {
      contentType: 'Social Media',
      platform: 'Instagram',
      format: 'Static Post',
      input: '',
      loading: false,
      loadingStage: '',
      generated: null,
      error: null,
      copied: false,
      brandData: { tov: [], audience: [], messaging: [], colors: [], guidelines: [], imageBank: [], loaded: false }
    };

    const SOCIAL_TYPES = ['Social Media', 'Paid Media'];
    const PLATFORMS = ['Instagram', 'LinkedIn', 'Facebook'];
    const FORMATS = ['Static Post', 'Carousel', 'Paid Ad'];
    const CONTENT_TYPES = ['Social Media', 'Paid Media', 'PR News', 'Thought Leadership', 'Case Study', 'Newsletter'];

    const IMAGE_SPECS = {
      'Instagram': { 'Static Post': { w: 1080, h: 1080, label: '1:1 Square', ratio: '1:1' }, 'Carousel': { w: 1080, h: 1080, label: '1:1', ratio: '1:1' }, 'Paid Ad': { w: 1080, h: 1350, label: '4:5', ratio: '4:5' } },
      'LinkedIn': { 'Static Post': { w: 1200, h: 627, label: '1.91:1', ratio: '16:9' }, 'Carousel': { w: 1080, h: 1080, label: '1:1', ratio: '1:1' }, 'Paid Ad': { w: 1200, h: 627, label: '1.91:1', ratio: '16:9' } },
      'Facebook': { 'Static Post': { w: 1200, h: 630, label: '1.91:1', ratio: '16:9' }, 'Carousel': { w: 1080, h: 1080, label: '1:1', ratio: '1:1' }, 'Paid Ad': { w: 1080, h: 1080, label: '1:1', ratio: '1:1' } }
    };

    // ============================================
    // SUPABASE
    // ============================================
    async function supabaseQuery(table) {
      try {
        const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/${table}?select=*`, {
          headers: {
            'apikey': CONFIG.SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) throw new Error(`Failed to fetch ${table}`);
        return await response.json();
      } catch (error) {
        console.error(`Supabase error (${table}):`, error);
        return [];
      }
    }

    async function loadBrandData() {
      try {
        const [tov, audience, messaging, colors, guidelines, imageBank] = await Promise.all([
          supabaseQuery('tone_of_voice'),
          supabaseQuery('target_audience'),
          supabaseQuery('messaging_framework'),
          supabaseQuery('brand_colors'),
          supabaseQuery('brand_guidelines'),
          supabaseQuery('brand_image_bank')
        ]);
        state.brandData = { tov, audience, messaging, colors, guidelines, imageBank, loaded: true };
        render();
      } catch (err) {
        console.error('Failed to load brand data:', err);
        state.brandData.loaded = true;
        render();
      }
    }

    // ============================================
    // GROQ API - TEXT GENERATION
    // ============================================
    async function generateCopyWithGroq(prompt) {
      const { tov, audience, messaging } = state.brandData;
      
      const systemContext = `You are a brand content creator. Generate content following these brand guidelines:

TONE OF VOICE:
${tov.map(t => `- ${t.tov_name || t.content_type}: ${t.writing_style_description || ''}`).join('\n') || 'Professional and engaging'}

TARGET AUDIENCE:
${audience.map(a => `- ${a.persona_name || 'Target'}: ${a.goals_motivations || ''}`).join('\n') || 'Business professionals'}

KEY MESSAGING:
${messaging.map(m => `- ${m.message_name || m.message_type}: ${m.message_text || ''}`).join('\n') || 'Value-driven messaging'}

Generate authentic, engaging content aligned with the brand voice. Be creative and compelling.`;

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${CONFIG.GROQ_API_KEY}`
        },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: systemContext },
            { role: 'user', content: prompt }
          ],
          temperature: 0.8,
          max_tokens: 1024
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error?.message || 'Groq API failed');
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    // ============================================
    // POLLINATIONS.AI - FREE IMAGE GENERATION
    // ============================================
    function generateImageWithPollinations(prompt) {
      const { imageBank } = state.brandData;
      
      // Aggregate style data from all brand_image_bank entries
      let styles = [];
      let moods = [];
      let brandValues = [];
      let descriptions = [];
      
      if (imageBank && imageBank.length > 0) {
        imageBank.forEach(img => {
          if (img.style) styles.push(img.style);
          if (img.mood) moods.push(img.mood);
          if (img.brand_values) brandValues.push(img.brand_values);
          if (img.description) descriptions.push(img.description);
        });
      }
      
      // Create unique, comma-separated lists
      const uniqueStyles = [...new Set(styles)].slice(0, 3).join(', ') || 'Modern, professional, clean';
      const uniqueMoods = [...new Set(moods)].slice(0, 3).join(', ') || 'sophisticated, inspiring';
      const uniqueValues = [...new Set(brandValues)].slice(0, 3).join(', ') || 'innovative, trustworthy';
      const styleDescription = descriptions[0] || '';
      
      const enhancedPrompt = encodeURIComponent(
        `${prompt}. 
        Visual style: ${uniqueStyles}. 
        Mood: ${uniqueMoods}. 
        Brand essence: ${uniqueValues}. 
        ${styleDescription ? `Reference: ${styleDescription}.` : ''}
        High quality, professional social media content, suitable for brand marketing.`
      );
      
      // Pollinations.ai returns an image URL directly - no API key needed!
      return `https://image.pollinations.ai/prompt/${enhancedPrompt}?width=1080&height=1080&nologo=true`;
    }

    // ============================================
    // GENERATE CONTENT
    // ============================================
    async function generate() {
      if (!state.input.trim() || state.loading) return;
      
      state.loading = true;
      state.error = null;
      state.generated = null;
      render();

      try {
        const showPlatformOptions = SOCIAL_TYPES.includes(state.contentType);
        const imageSpec = showPlatformOptions ? IMAGE_SPECS[state.platform]?.[state.format] : null;
        
        let copyPrompt = '';
        switch (state.contentType) {
          case 'Social Media':
            copyPrompt = `Create a ${state.platform} ${state.format.toLowerCase()} caption for: ${state.input}. Keep it engaging for ${state.platform}. Include a call-to-action and relevant hashtags at the end.`;
            break;
          case 'Paid Media':
            copyPrompt = `Create paid ad copy for ${state.platform} (${state.format}) about: ${state.input}. Include: Headline (max 40 chars), Primary text, and CTA. Format with clear labels.`;
            break;
          case 'PR News':
            copyPrompt = `Write a press release about: ${state.input}. Include: Headline, dateline, lead paragraph, quotes, and boilerplate.`;
            break;
          case 'Thought Leadership':
            copyPrompt = `Write a thought leadership article about: ${state.input}. Include: Headline, introduction, 2-3 key insights, and conclusion.`;
            break;
          case 'Case Study':
            copyPrompt = `Create a case study about: ${state.input}. Include: Challenge, Solution, Results with metrics, and client quote.`;
            break;
          case 'Newsletter':
            copyPrompt = `Write a newsletter email about: ${state.input}. Include: Subject line, preview text, greeting, main content, and sign-off.`;
            break;
          default:
            copyPrompt = state.input;
        }

        state.loadingStage = 'Crafting your copy...';
        render();
        const copy = await generateCopyWithGroq(copyPrompt);

        let imageUrl = null;
        if (showPlatformOptions && imageSpec) {
          state.loadingStage = 'Creating your image...';
          render();
          imageUrl = generateImageWithPollinations(`Professional social media image for: ${state.input}. For ${state.platform} ${state.format}.`);
        }

        state.generated = { copy, imageUrl, imageSpec, platform: state.platform, format: state.format, contentType: state.contentType };
        state.input = '';
      } catch (err) {
        console.error('Generation error:', err);
        state.error = err.message || 'Failed to generate content.';
      } finally {
        state.loading = false;
        state.loadingStage = '';
        render();
      }
    }

    // ============================================
    // ACTIONS
    // ============================================
    function copyToClipboard() {
      if (state.generated?.copy) {
        navigator.clipboard.writeText(state.generated.copy);
        state.copied = true;
        render();
        setTimeout(() => { state.copied = false; render(); }, 2000);
      }
    }

    function downloadImage() {
      if (state.generated?.imageUrl) {
        const link = document.createElement('a');
        link.href = state.generated.imageUrl;
        link.download = `${state.platform}-${state.format.replace(/\s+/g, '-').toLowerCase()}-${Date.now()}.png`;
        link.target = '_blank';
        link.click();
      }
    }

    function reset() {
      state.generated = null;
      state.input = '';
      state.error = null;
      render();
    }

    function updateState(key, value) {
      state[key] = value;
      if (key === 'contentType') {
        state.generated = null;
        state.error = null;
      }
      render();
    }

    // ============================================
    // RENDER
    // ============================================
    function render() {
      const app = document.getElementById('app');
      const showPlatformOptions = SOCIAL_TYPES.includes(state.contentType);
      
      if (!state.brandData.loaded) {
        app.innerHTML = `
          <div class="flex flex-col h-screen bg-gradient-to-br from-slate-50 to-slate-100 items-center justify-center">
            <div class="w-8 h-8 border-3 border-purple-600 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-slate-600 text-sm">Loading brand data...</p>
          </div>
        `;
        return;
      }

      let mainContent = '';
      
      if (state.loading) {
        mainContent = `
          <div class="flex flex-col items-center justify-center h-full">
            <div class="relative mb-6">
              <div class="w-16 h-16 bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 rounded-2xl animate-pulse"></div>
            </div>
            <div class="flex gap-1 mb-4">
              <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
              <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.15s"></div>
              <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.3s"></div>
            </div>
            <p class="text-slate-700 font-medium">${state.loadingStage || 'Generating...'}</p>
            ${showPlatformOptions ? `<p class="text-slate-400 text-sm mt-1">Creating ${state.format} for ${state.platform}</p>` : ''}
          </div>
        `;
      } else if (state.error) {
        mainContent = `
          <div class="flex flex-col items-center justify-center h-full">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mb-4">
              <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            </div>
            <p class="text-red-600 font-medium mb-2">Generation Failed</p>
            <p class="text-slate-500 text-sm text-center mb-4 max-w-xs">${state.error}</p>
            <button onclick="state.error = null; render();" class="px-4 py-2 bg-slate-900 text-white rounded-xl text-sm font-medium hover:bg-slate-800">Try again</button>
          </div>
        `;
      } else if (state.generated) {
        const g = state.generated;
        mainContent = `
          <div class="space-y-4">
            ${g.imageSpec ? `
              <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-semibold text-slate-600">${g.platform} â€¢ ${g.format}</span>
                  <span class="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded-full">${g.imageSpec.label}</span>
                </div>
                <div class="flex justify-center">
                  ${g.imageUrl ? `
                    <img src="${g.imageUrl}" alt="Generated" class="rounded-xl max-w-full shadow-lg" style="max-height: 280px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                    <div class="bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 rounded-xl items-center justify-center text-white hidden" style="width: 250px; height: 250px;">
                      <div class="text-center p-4">
                        <svg class="w-8 h-8 mx-auto mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                        <p class="text-xs opacity-80">Image loading...</p>
                      </div>
                    </div>
                  ` : `
                    <div class="bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 rounded-xl flex items-center justify-center text-white" style="width: 250px; height: 250px;">
                      <div class="text-center p-4">
                        <svg class="w-8 h-8 mx-auto mb-2 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                        <p class="text-xs opacity-80">Image unavailable</p>
                      </div>
                    </div>
                  `}
                </div>
                ${g.imageUrl ? `<button onclick="downloadImage()" class="w-full mt-4 px-4 py-2.5 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium hover:bg-slate-200 flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                  Download Image
                </button>` : ''}
              </div>
            ` : ''}
            
            <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-semibold text-slate-600">${showPlatformOptions ? 'Caption / Copy' : g.contentType}</span>
              </div>
              <div class="bg-slate-50 rounded-xl p-4 mb-4 max-h-64 overflow-y-auto">
                <p class="text-sm text-slate-700 whitespace-pre-wrap leading-relaxed">${g.copy}</p>
              </div>
              <button onclick="copyToClipboard()" class="w-full px-4 py-2.5 rounded-xl text-sm font-medium flex items-center justify-center gap-2 ${state.copied ? 'bg-green-500 text-white' : 'bg-slate-900 text-white hover:bg-slate-800'}">
                ${state.copied ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Copied!` : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg> Copy to Clipboard`}
              </button>
            </div>
            
            <button onclick="reset()" class="w-full px-4 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl text-sm font-medium hover:bg-slate-50 flex items-center justify-center gap-2 shadow-sm">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Create New Content
            </button>
          </div>
        `;
      } else {
        mainContent = `
          <div class="flex flex-col items-center justify-center h-full">
            <div class="relative mb-6">
              <div class="w-20 h-20 bg-gradient-to-br from-purple-100 via-pink-100 to-orange-100 rounded-3xl flex items-center justify-center">
                <svg class="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3L12 3Z"/></svg>
              </div>
              ${state.brandData.tov.length > 0 ? `<div class="absolute -bottom-1 -right-1 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center border-2 border-white"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></div>` : ''}
            </div>
            <h3 class="font-bold text-slate-900 text-lg mb-1">What would you like to create?</h3>
            <p class="text-sm text-slate-500 mb-3 text-center">${state.brandData.tov.length > 0 ? 'Your brand data is loaded and ready' : 'Enter a prompt to generate content'}</p>
            <div class="flex flex-wrap gap-2 justify-center">
              <span class="text-xs text-purple-600 bg-purple-50 px-3 py-1.5 rounded-full font-medium">${showPlatformOptions ? `${state.format} for ${state.platform}` : state.contentType}</span>
              ${state.brandData.tov.length > 0 ? `<span class="text-xs text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full font-medium">${state.brandData.tov.length} voice styles</span>` : ''}
              ${state.brandData.imageBank.length > 0 ? `<span class="text-xs text-pink-600 bg-pink-50 px-3 py-1.5 rounded-full font-medium">${state.brandData.imageBank.length} image styles</span>` : ''}
            </div>
          </div>
        `;
      }

      app.innerHTML = `
        <div class="flex flex-col h-screen bg-gradient-to-br from-slate-50 to-slate-100">
          <!-- Header -->
          <div class="bg-white/80 backdrop-blur-xl border-b border-slate-200/50 px-4 py-4">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 bg-gradient-to-br from-purple-600 via-pink-500 to-orange-400 rounded-xl flex items-center justify-center shadow-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="m12 3-1.9 5.8a2 2 0 0 1-1.3 1.3L3 12l5.8 1.9a2 2 0 0 1 1.3 1.3L12 21l1.9-5.8a2 2 0 0 1 1.3-1.3L21 12l-5.8-1.9a2 2 0 0 1-1.3-1.3L12 3Z"/></svg>
              </div>
              <div>
                <h1 class="font-bold text-slate-900 text-lg">Content Studio</h1>
                <p class="text-xs text-slate-500">AI-powered brand content</p>
              </div>
              ${state.brandData.tov.length > 0 ? `<div class="ml-auto flex items-center gap-1 text-green-600 text-xs bg-green-50 px-2 py-1 rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg><span>Connected</span></div>` : ''}
            </div>
            
            <div class="space-y-3">
              <select onchange="updateState('contentType', this.value)" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                ${CONTENT_TYPES.map(t => `<option value="${t}" ${state.contentType === t ? 'selected' : ''}>${t}</option>`).join('')}
              </select>
              
              ${showPlatformOptions ? `
                <div class="grid grid-cols-2 gap-3">
                  <select onchange="updateState('platform', this.value)" class="px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    ${PLATFORMS.map(p => `<option value="${p}" ${state.platform === p ? 'selected' : ''}>${p}</option>`).join('')}
                  </select>
                  <select onchange="updateState('format', this.value)" class="px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                    ${FORMATS.map(f => `<option value="${f}" ${state.format === f ? 'selected' : ''}>${f}</option>`).join('')}
                  </select>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- Main Content -->
          <div class="flex-1 overflow-y-auto p-4">
            ${mainContent}
          </div>
          
          <!-- Input Area -->
          ${!state.loading && !state.generated ? `
            <div class="bg-white/80 backdrop-blur-xl border-t border-slate-200/50 p-4">
              <div class="flex gap-3">
                <input type="text" id="promptInput" value="${state.input}" oninput="state.input = this.value" onkeypress="if(event.key === 'Enter') generate()" placeholder="Describe what content you need..." class="flex-1 px-4 py-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-purple-500/20 shadow-sm" />
                <button onclick="generate()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl text-sm font-semibold hover:from-purple-700 hover:to-pink-700 shadow-lg">Generate</button>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Initialize
    loadBrandData();
  </script>
</body>
</html>
